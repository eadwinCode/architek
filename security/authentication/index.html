<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Ellar - Python ASGI web framework for building fast, efficient and scalable RESTAPIs and server-side application."><link href=https://github.com/python-ellar/ellar/security/authentication/ rel=canonical><link href=../../techniques/background-task/ rel=prev><link href=../authorization/ rel=next><link rel=icon href=../../img/Icon.svg><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.12"><title>Authentication -</title><link rel=stylesheet href=../../assets/stylesheets/main.7e359304.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Source Sans Pro";--md-code-font:"Fira Code"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=pink data-md-color-accent=pink> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#authentication class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title class="md-header__button md-logo" aria-label data-md-component=logo> <img src=../../img/EllarLogoB.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Authentication </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=pink data-md-color-accent=pink aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=pink data-md-color-accent=pink aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/python-ellar/ellar title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> eadwinCode/ellar </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Get Started </a> </li> <li class=md-tabs__item> <a href=../../overview/step-one/ class=md-tabs__link> Overview </a> </li> <li class=md-tabs__item> <a href=../../basics/execution-context/ class=md-tabs__link> Essentials </a> </li> <li class=md-tabs__item> <a href=../../techniques/configurations/ class=md-tabs__link> Techniques </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=./ class=md-tabs__link> Security </a> </li> <li class=md-tabs__item> <a href=../../cli/introduction/ class=md-tabs__link> CLI </a> </li> <li class=md-tabs__item> <a href=../../openapi/ class=md-tabs__link> OPENAPI </a> </li> <li class=md-tabs__item> <a href=../../websockets/websockets/ class=md-tabs__link> WebSockets </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title class="md-nav__button md-logo" aria-label data-md-component=logo> <img src=../../img/EllarLogoB.png alt=logo> </a> </label> <div class=md-nav__source> <a href=https://github.com/python-ellar/ellar title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> eadwinCode/ellar </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Get Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../overview/step-one/ class=md-nav__link> <span class=md-ellipsis> Overview </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../basics/execution-context/ class=md-nav__link> <span class=md-ellipsis> Essentials </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../techniques/configurations/ class=md-nav__link> <span class=md-ellipsis> Techniques </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Security </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Security </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Authentication </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Authentication </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-guard-authentication class=md-nav__link> <span class=md-ellipsis> 1. Guard Authentication </span> </a> <nav class=md-nav aria-label="1. Guard Authentication"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#creating-an-authentication-module class=md-nav__link> <span class=md-ellipsis> Creating an authentication module </span> </a> </li> <li class=md-nav__item> <a href=#implementing-the-sign-in-endpoint class=md-nav__link> <span class=md-ellipsis> Implementing the "Sign in" endpoint </span> </a> </li> <li class=md-nav__item> <a href=#implementing-the-authentication-guard class=md-nav__link> <span class=md-ellipsis> Implementing the authentication guard </span> </a> </li> <li class=md-nav__item> <a href=#refresh-token class=md-nav__link> <span class=md-ellipsis> Refresh Token </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#apply-authguard-globally class=md-nav__link> <span class=md-ellipsis> Apply AuthGuard Globally </span> </a> <nav class=md-nav aria-label="Apply AuthGuard Globally"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#anonymous-route-function-mechanism class=md-nav__link> <span class=md-ellipsis> Anonymous Route Function Mechanism </span> </a> <nav class=md-nav aria-label="Anonymous Route Function Mechanism"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#using-allow_any-decorator-function class=md-nav__link> <span class=md-ellipsis> Using allow_any decorator function </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-authentication-schemes class=md-nav__link> <span class=md-ellipsis> 2. Authentication Schemes </span> </a> <nav class=md-nav aria-label="2. Authentication Schemes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#creating-a-jwt-authentication-handler class=md-nav__link> <span class=md-ellipsis> Creating a JWT Authentication Handler </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../authorization/ class=md-nav__link> <span class=md-ellipsis> Authorization </span> </a> </li> <li class=md-nav__item> <a href=../encryption_and_hashing/ class=md-nav__link> <span class=md-ellipsis> Encryption and Hashing </span> </a> </li> <li class=md-nav__item> <a href=../csrf/ class=md-nav__link> <span class=md-ellipsis> CSRF and CORS </span> </a> </li> <li class=md-nav__item> <a href=../sessions/ class=md-nav__link> <span class=md-ellipsis> Sessions </span> </a> </li> <li class=md-nav__item> <a href=../rate-limit/ class=md-nav__link> <span class=md-ellipsis> Rate Limiting </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../cli/introduction/ class=md-nav__link> <span class=md-ellipsis> CLI </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../openapi/ class=md-nav__link> <span class=md-ellipsis> OPENAPI </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../websockets/websockets/ class=md-nav__link> <span class=md-ellipsis> WebSockets </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-guard-authentication class=md-nav__link> <span class=md-ellipsis> 1. Guard Authentication </span> </a> <nav class=md-nav aria-label="1. Guard Authentication"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#creating-an-authentication-module class=md-nav__link> <span class=md-ellipsis> Creating an authentication module </span> </a> </li> <li class=md-nav__item> <a href=#implementing-the-sign-in-endpoint class=md-nav__link> <span class=md-ellipsis> Implementing the "Sign in" endpoint </span> </a> </li> <li class=md-nav__item> <a href=#implementing-the-authentication-guard class=md-nav__link> <span class=md-ellipsis> Implementing the authentication guard </span> </a> </li> <li class=md-nav__item> <a href=#refresh-token class=md-nav__link> <span class=md-ellipsis> Refresh Token </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#apply-authguard-globally class=md-nav__link> <span class=md-ellipsis> Apply AuthGuard Globally </span> </a> <nav class=md-nav aria-label="Apply AuthGuard Globally"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#anonymous-route-function-mechanism class=md-nav__link> <span class=md-ellipsis> Anonymous Route Function Mechanism </span> </a> <nav class=md-nav aria-label="Anonymous Route Function Mechanism"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#using-allow_any-decorator-function class=md-nav__link> <span class=md-ellipsis> Using allow_any decorator function </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-authentication-schemes class=md-nav__link> <span class=md-ellipsis> 2. Authentication Schemes </span> </a> <nav class=md-nav aria-label="2. Authentication Schemes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#creating-a-jwt-authentication-handler class=md-nav__link> <span class=md-ellipsis> Creating a JWT Authentication Handler </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/python-ellar/ellar/blob/master/docs/security/authentication.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg> </a> <a href=https://github.com/python-ellar/ellar/raw/master/docs/security/authentication.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.15 8.15 0 0 1-1.23-2Z"/></svg> </a> <h1 id=authentication><strong>Authentication</strong><a class=headerlink href=#authentication title="Permanent link">&para;</a></h1> <p>Authentication is an <strong>essential</strong> part of most applications. It refers to the methods and techniques used to verify the identity of users interacting with your application. There are many different approaches and strategies to handle authentication. The approach taken for any project depends on its particular application requirements. In this section, we shall go through different approaches to authentication in Ellar and how it will suit your authentication requirements.</p> <p>There are two ways in which user authentication and identification are processed in Ellar:</p> <ul> <li><a href=#1-guard-authentication>Using Guards</a></li> <li><a href=#2-authentication-schemes>Using Authentication Schemes</a></li> </ul> <h2 id=1-guard-authentication><strong>1. Guard Authentication</strong><a class=headerlink href=#1-guard-authentication title="Permanent link">&para;</a></h2> <p>We have discussed in detail how Guards are used to protect a route and check for user authorizations, but we never really addressed how they can be used for authentication purposes. For this, we are going to illustrate JWT authentication using Guard</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Read more on <a href=../../overview/guards/ target=_blank>Guards</a></p> </div> <p>Let's flesh out our requirements. For this use case, clients will start by authenticating with a username and password. Once authenticated, the server will issue a JWT that can be sent as a bearer token in an authorization header on subsequent requests to prove authentication. Then, we create a protected route that is accessible only to requests that contain a valid JWT.</p> <p>Let's start with the first requirement: authenticating a user, then extend that by issuing a JWT. And finally, we'll create a protected route that checks for a valid JWT on the request.</p> <h3 id=creating-an-authentication-module><strong>Creating an authentication module</strong><a class=headerlink href=#creating-an-authentication-module title="Permanent link">&para;</a></h3> <p>We´ll start by scaffolding an <code>AuthModule</code> with the Ellar CLI tool followed by <code>AuthService</code> and <code>AuthController</code> implementations. We´ll use the <code>AuthService</code> to implement the authentication logic and the <code>AuthController</code> to expose the authentication endpoints.</p> <div class=highlight><pre><span></span><code>ellar<span class=w> </span>create-module<span class=w> </span>auth
</code></pre></div> <p>Also, the AuthService would need UserService, which encapsulates user operations. Let's also scaffold a user module.</p> <div class=highlight><pre><span></span><code>ellar<span class=w> </span>create-module<span class=w> </span>user
</code></pre></div> <p>Now, let's add some implementations to the generated files. For this application, the <code>UserService</code> will be working with a hard-coded list of users with a retrieve one-by-email method. In a real application, you´d build your user model and persistence layer using a library of your choice like SQLAlchemy, Django ORM, Peewee, PonyORM, etc.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>user/services.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>Serializer</span>
<span class=kn>from</span> <span class=nn>ellar.common.serializer</span> <span class=kn>import</span> <span class=n>SerializerFilter</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>injectable</span>
<span class=kn>from</span> <span class=nn>ellar.core.security.hashers</span> <span class=kn>import</span> <span class=n>make_password</span>


<span class=k>class</span> <span class=nc>UserModel</span><span class=p>(</span><span class=n>Serializer</span><span class=p>):</span>
    <span class=n>_filter</span> <span class=o>=</span> <span class=n>SerializerFilter</span><span class=p>(</span><span class=n>exclude</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;password&#39;</span><span class=p>})</span>

    <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>password</span><span class=p>:</span> <span class=nb>str</span>


<span class=nd>@injectable</span><span class=p>()</span>
<span class=k>class</span> <span class=nc>UsersService</span><span class=p>:</span>
    <span class=n>users</span> <span class=o>=</span> <span class=p>[</span>
        <span class=p>{</span>
            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
            <span class=s1>&#39;username&#39;</span><span class=p>:</span> <span class=s1>&#39;john&#39;</span><span class=p>,</span>
            <span class=s1>&#39;password&#39;</span><span class=p>:</span> <span class=n>make_password</span><span class=p>(</span><span class=s1>&#39;password&#39;</span><span class=p>),</span>
        <span class=p>},</span>
        <span class=p>{</span>
            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
            <span class=s1>&#39;username&#39;</span><span class=p>:</span> <span class=s1>&#39;clara&#39;</span><span class=p>,</span>
            <span class=s1>&#39;password&#39;</span><span class=p>:</span> <span class=n>make_password</span><span class=p>(</span><span class=s1>&#39;guess&#39;</span><span class=p>),</span>
        <span class=p>},</span>
    <span class=p>]</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_user_by_username</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>UserModel</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
        <span class=n>filtered_list</span> <span class=o>=</span> <span class=nb>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>item</span><span class=p>:</span> <span class=n>item</span><span class=p>[</span><span class=s2>&quot;username&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>username</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>users</span><span class=p>)</span>
        <span class=n>found_user</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>filtered_list</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>found_user</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>UserModel</span><span class=p>(</span><span class=o>**</span><span class=n>found_user</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> <p>In the above example, we have used <code>make_password</code> to hash the password. It is strictly advised you don't save passwords as plain text. In the <code>UsersModule</code>, we need to register the <code>UserService</code> we just created so that it will be injectable in <code>AuthService</code></p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>user/module.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>Module</span>
<span class=kn>from</span> <span class=nn>ellar.core</span> <span class=kn>import</span> <span class=n>ModuleBase</span>

<span class=kn>from</span> <span class=nn>.services</span> <span class=kn>import</span> <span class=n>UsersService</span>


<span class=nd>@Module</span><span class=p>(</span>
    <span class=n>providers</span><span class=o>=</span><span class=p>[</span><span class=n>UsersService</span><span class=p>],</span>
<span class=p>)</span>
<span class=k>class</span> <span class=nc>UserModule</span><span class=p>(</span><span class=n>ModuleBase</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    User Module</span>
<span class=sd>    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div> <h3 id=implementing-the-sign-in-endpoint><strong>Implementing the "Sign in" endpoint</strong><a class=headerlink href=#implementing-the-sign-in-endpoint title="Permanent link">&para;</a></h3> <p>The <code>AuthService</code> has the job of retrieving a user and verifying the password. Let's create a <code>sign_in</code> function for this purpose.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/services.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>import</span> <span class=nn>typing</span> <span class=k>as</span> <span class=nn>t</span>

<span class=kn>from</span> <span class=nn>ellar.core.security.hashers</span> <span class=kn>import</span> <span class=n>check_password</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>injectable</span>
<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>exceptions</span>
<span class=kn>from</span> <span class=nn>..user.services</span> <span class=kn>import</span> <span class=n>UsersService</span>


<span class=nd>@injectable</span><span class=p>()</span>
<span class=k>class</span> <span class=nc>AuthService</span><span class=p>:</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>users_service</span><span class=p>:</span> <span class=n>UsersService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>users_service</span> <span class=o>=</span> <span class=n>users_service</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>sign_in</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>password</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>:</span>
        <span class=n>user_model</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>users_service</span><span class=o>.</span><span class=n>get_user_by_username</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>user_model</span><span class=p>:</span>
            <span class=k>raise</span> <span class=n>exceptions</span><span class=o>.</span><span class=n>AuthenticationFailed</span><span class=p>()</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>check_password</span><span class=p>(</span><span class=n>user_model</span><span class=o>.</span><span class=n>password</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>exceptions</span><span class=o>.</span><span class=n>AuthenticationFailed</span><span class=p>()</span>

        <span class=k>return</span> <span class=n>user_model</span><span class=o>.</span><span class=n>serialize</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> <p>Next, we create the AuthController and add a sign_in endpoint</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/controllers.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>Controller</span><span class=p>,</span> <span class=n>ControllerBase</span><span class=p>,</span> <span class=n>post</span><span class=p>,</span> <span class=n>Body</span>
<span class=kn>from</span> <span class=nn>.services</span> <span class=kn>import</span> <span class=n>AuthService</span>


<span class=nd>@Controller</span>
<span class=k>class</span> <span class=nc>AuthController</span><span class=p>(</span><span class=n>ControllerBase</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>auth_service</span><span class=p>:</span> <span class=n>AuthService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span> <span class=o>=</span> <span class=n>auth_service</span>

    <span class=nd>@post</span><span class=p>(</span><span class=s2>&quot;/login&quot;</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>sign_in</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>password</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span><span class=o>.</span><span class=n>sign_in</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>password</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> <p>At this junction, the <code>AuthService</code> returns a Python dictionary object of the user retrieved if the password is correct. But in the real sense, we need a token returned to the client. </p> <p>For this, we need to install the <code>ellar-jwt</code> package</p> <div class=highlight><pre><span></span><code>pip<span class=w> </span>install<span class=w> </span>ellar-jwt
</code></pre></div> <p>Let us review and refine our requirements once again:</p> <ul> <li>Allow users to authenticate with username/password, returning a JWT for use in subsequent calls to protected API endpoints. This is almost done. What is left is to write the code that issues a JWT.</li> <li>Create API routes that are protected based on the presence of a valid JWT as a bearer token</li> </ul> <p>EllarJWT comes with <code>JWTModule</code> and <code>JWTService</code> for encoding and decoding tokens. Let us configure the JWTModule inside AuthModule. </p> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>You can also see docs on how to use the <a href=https://github.com/python-ellar/ellar-jwt target=_blank>EllarJWT</a></p> </div> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/module.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>timedelta</span>

<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>Module</span>
<span class=kn>from</span> <span class=nn>ellar.core</span> <span class=kn>import</span> <span class=n>ModuleBase</span><span class=p>,</span> <span class=n>LazyModuleImport</span> <span class=k>as</span> <span class=n>lazyLoad</span>
<span class=kn>from</span> <span class=nn>ellar_jwt</span> <span class=kn>import</span> <span class=n>JWTModule</span>

<span class=kn>from</span> <span class=nn>.controllers</span> <span class=kn>import</span> <span class=n>AuthController</span>
<span class=kn>from</span> <span class=nn>.services</span> <span class=kn>import</span> <span class=n>AuthService</span>


<span class=nd>@Module</span><span class=p>(</span>
    <span class=n>modules</span><span class=o>=</span><span class=p>[</span>
        <span class=n>lazyLoad</span><span class=p>(</span><span class=s1>&#39;project_name.users.module:UserModule&#39;</span><span class=p>),</span>
        <span class=n>JWTModule</span><span class=o>.</span><span class=n>setup</span><span class=p>(</span>
            <span class=n>signing_secret_key</span><span class=o>=</span><span class=s2>&quot;my_poor_secret_key_lol&quot;</span><span class=p>,</span> <span class=n>lifetime</span><span class=o>=</span><span class=n>timedelta</span><span class=p>(</span><span class=n>minutes</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
        <span class=p>),</span>
    <span class=p>],</span>
    <span class=n>controllers</span><span class=o>=</span><span class=p>[</span><span class=n>AuthController</span><span class=p>],</span>
    <span class=n>providers</span><span class=o>=</span><span class=p>[</span><span class=n>AuthService</span><span class=p>],</span>
<span class=p>)</span>
<span class=k>class</span> <span class=nc>AuthModule</span><span class=p>(</span><span class=n>ModuleBase</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Auth Module</span>
<span class=sd>    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div> <p>In the above example, we configured <code>JWTModule</code> with very minimal configurations and registered it as a module dependency together with <code>UserModule</code>. Also we have registered <code>AuthController</code> and <code>AuthService</code> to <code>AuthModule</code> as well. With that done, we have completed the <code>AuthModule</code> setup. </p> <p>Now, let us finish the <code>AuthService</code> by returning a token using <code>JWTService</code>.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/services.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>import</span> <span class=nn>typing</span> <span class=k>as</span> <span class=nn>t</span>

<span class=kn>from</span> <span class=nn>ellar.core.security.hashers</span> <span class=kn>import</span> <span class=n>check_password</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>injectable</span>
<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>exceptions</span>
<span class=kn>from</span> <span class=nn>ellar_jwt</span> <span class=kn>import</span> <span class=n>JWTService</span>

<span class=kn>from</span> <span class=nn>..user.services</span> <span class=kn>import</span> <span class=n>UsersService</span>


<span class=nd>@injectable</span><span class=p>()</span>
<span class=k>class</span> <span class=nc>AuthService</span><span class=p>:</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>users_service</span><span class=p>:</span> <span class=n>UsersService</span><span class=p>,</span> <span class=n>jwt_service</span><span class=p>:</span> <span class=n>JWTService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>users_service</span> <span class=o>=</span> <span class=n>users_service</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span> <span class=o>=</span> <span class=n>jwt_service</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>sign_in</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>password</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>:</span>
        <span class=n>user_model</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>users_service</span><span class=o>.</span><span class=n>get_user_by_username</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>user_model</span><span class=p>:</span>
            <span class=k>raise</span> <span class=n>exceptions</span><span class=o>.</span><span class=n>AuthenticationFailed</span><span class=p>()</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>check_password</span><span class=p>(</span><span class=n>user_model</span><span class=o>.</span><span class=n>password</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>exceptions</span><span class=o>.</span><span class=n>AuthenticationFailed</span><span class=p>()</span>

        <span class=n>result</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;access_token&quot;</span><span class=p>:</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span><span class=o>.</span><span class=n>sign_async</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span><span class=n>user_model</span><span class=o>.</span><span class=n>serialize</span><span class=p>(),</span> <span class=n>sub</span><span class=o>=</span><span class=n>user_model</span><span class=o>.</span><span class=n>user_id</span><span class=p>))}</span>
        <span class=k>return</span> <span class=n>result</span>
</code></pre></div></td></tr></table></div> <p>At this point, we can run the application to test what we have done so far. To do that, we need to register <code>AuthModule</code> to the <code>ApplicationModule</code>.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>project_name/root_module.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>Module</span><span class=p>,</span> <span class=n>exception_handler</span>
<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>IExecutionContext</span><span class=p>,</span> <span class=n>JSONResponse</span><span class=p>,</span> <span class=n>Response</span>
<span class=kn>from</span> <span class=nn>ellar.core</span> <span class=kn>import</span> <span class=n>ModuleBase</span><span class=p>,</span> <span class=n>LazyModuleImport</span> <span class=k>as</span> <span class=n>lazyLoad</span>
<span class=kn>from</span> <span class=nn>ellar.samples.modules</span> <span class=kn>import</span> <span class=n>HomeModule</span>


<span class=nd>@Module</span><span class=p>(</span>
    <span class=n>modules</span><span class=o>=</span><span class=p>[</span><span class=n>HomeModule</span><span class=p>,</span> <span class=n>lazyLoad</span><span class=p>(</span><span class=s1>&#39;project_name.auth.module:AuthModule&#39;</span><span class=p>),],</span>
<span class=p>)</span>
<span class=k>class</span> <span class=nc>ApplicationModule</span><span class=p>(</span><span class=n>ModuleBase</span><span class=p>):</span>
    <span class=nd>@exception_handler</span><span class=p>(</span><span class=mi>404</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>exception_404_handler</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>ctx</span><span class=p>:</span> <span class=n>IExecutionContext</span><span class=p>,</span> <span class=n>exc</span><span class=p>:</span> <span class=ne>Exception</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Response</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>JSONResponse</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span><span class=n>detail</span><span class=o>=</span><span class=s2>&quot;Resource not found.&quot;</span><span class=p>))</span>
</code></pre></div></td></tr></table></div> <p>Then restart the server if it is not running. <div class=highlight><pre><span></span><code>ellar<span class=w> </span>runserver<span class=w> </span>--reload
</code></pre></div> Let us make some requests to the server. Open a terminal window and run the code below: <div class=highlight><pre><span></span><code>$<span class=w> </span><span class=c1># POST to /auth/login</span>
$<span class=w> </span>curl<span class=w> </span>-X<span class=w> </span>POST<span class=w> </span>http://localhost:8000/auth/login<span class=w> </span>-d<span class=w> </span><span class=s1>&#39;{&quot;username&quot;: &quot;john&quot;, &quot;password&quot;: &quot;password&quot;}&#39;</span><span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Content-Type: application/json&quot;</span>
<span class=o>{</span><span class=s2>&quot;access_token&quot;</span>:<span class=s2>&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTg3OTE0OTE...&quot;</span><span class=o>}</span>
$<span class=w> </span><span class=c1># Note: above JWT truncated</span>
</code></pre></div></p> <h3 id=implementing-the-authentication-guard><strong>Implementing the authentication guard</strong><a class=headerlink href=#implementing-the-authentication-guard title="Permanent link">&para;</a></h3> <p>At this point, we can now comfortably address our final requirement: protecting endpoints by requiring a valid JWT to be present on the request. We will do this by creating an AuthGuard that will be used to guard our routes. </p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/guards.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>import</span> <span class=nn>typing</span> <span class=k>as</span> <span class=nn>t</span>

<span class=kn>from</span> <span class=nn>ellar.auth</span> <span class=kn>import</span> <span class=n>UserIdentity</span>
<span class=kn>from</span> <span class=nn>ellar.common.serializer.guard</span> <span class=kn>import</span> <span class=p>(</span>
    <span class=n>HTTPAuthorizationCredentials</span><span class=p>,</span>
<span class=p>)</span>
<span class=kn>from</span> <span class=nn>ellar.auth.guards</span> <span class=kn>import</span> <span class=n>GuardHttpBearerAuth</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>injectable</span>
<span class=kn>from</span> <span class=nn>ellar_jwt</span> <span class=kn>import</span> <span class=n>JWTService</span>
<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>logger</span><span class=p>,</span> <span class=n>IExecutionContext</span>


<span class=nd>@injectable</span>
<span class=k>class</span> <span class=nc>AuthGuard</span><span class=p>(</span><span class=n>GuardHttpBearerAuth</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>jwt_service</span><span class=p>:</span> <span class=n>JWTService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span> <span class=o>=</span> <span class=n>jwt_service</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>authentication_handler</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>context</span><span class=p>:</span> <span class=n>IExecutionContext</span><span class=p>,</span>
        <span class=n>credentials</span><span class=p>:</span> <span class=n>HTTPAuthorizationCredentials</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>]:</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span><span class=o>.</span><span class=n>decode_async</span><span class=p>(</span><span class=n>credentials</span><span class=o>.</span><span class=n>credentials</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>UserIdentity</span><span class=p>(</span><span class=n>auth_type</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>scheme</span><span class=p>,</span> <span class=o>**</span><span class=n>data</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>ex</span><span class=p>:</span>
            <span class=n>logger</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;[AuthGuard] Exception: </span><span class=si>{</span><span class=n>ex</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>raise_exception</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> <p>We can now implement our protected route and register our AuthGuard to guard it.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/controllers.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>Controller</span><span class=p>,</span> <span class=n>ControllerBase</span><span class=p>,</span> <span class=n>post</span><span class=p>,</span> <span class=n>Body</span><span class=p>,</span> <span class=n>get</span><span class=p>,</span> <span class=n>UseGuards</span>
<span class=kn>from</span> <span class=nn>.services</span> <span class=kn>import</span> <span class=n>AuthService</span>
<span class=kn>from</span> <span class=nn>.guards</span> <span class=kn>import</span> <span class=n>AuthGuard</span>


<span class=nd>@Controller</span>
<span class=k>class</span> <span class=nc>AuthController</span><span class=p>(</span><span class=n>ControllerBase</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>auth_service</span><span class=p>:</span> <span class=n>AuthService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span> <span class=o>=</span> <span class=n>auth_service</span>

    <span class=nd>@post</span><span class=p>(</span><span class=s2>&quot;/login&quot;</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>sign_in</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>password</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span><span class=o>.</span><span class=n>sign_in</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>password</span><span class=p>)</span>

    <span class=nd>@get</span><span class=p>(</span><span class=s2>&quot;/profile&quot;</span><span class=p>)</span>
    <span class=nd>@UseGuards</span><span class=p>(</span><span class=n>AuthGuard</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_profile</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>user</span>
</code></pre></div></td></tr></table></div> <p>Ensure the app is running, and test the routes using <code>cURL</code>.</p> <div class=highlight><pre><span></span><code>$<span class=w> </span><span class=c1># GET /auth/profile</span>
$<span class=w> </span>curl<span class=w> </span>http://localhost:8000/auth/profile
<span class=o>{</span><span class=s2>&quot;detail&quot;</span>:<span class=s2>&quot;Forbidden&quot;</span><span class=o>}</span><span class=w> </span><span class=c1># status_code=403</span>

$<span class=w> </span><span class=c1># POST /auth/login</span>
$<span class=w> </span>curl<span class=w> </span>-X<span class=w> </span>POST<span class=w> </span>http://localhost:8000/auth/login<span class=w> </span>-d<span class=w> </span><span class=s1>&#39;{&quot;username&quot;: &quot;john&quot;, &quot;password&quot;: &quot;password&quot;}&#39;</span><span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Content-Type: application/json&quot;</span>
<span class=o>{</span><span class=s2>&quot;access_token&quot;</span>:<span class=s2>&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTg3OTE0OTE...&quot;</span><span class=o>}</span>

$<span class=w> </span><span class=c1># GET /profile using access_token returned from previous step as bearer code</span>
$<span class=w> </span>curl<span class=w> </span>http://localhost:8000/auth/profile<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm...&quot;</span>
<span class=o>{</span><span class=s2>&quot;exp&quot;</span>:1698793558,<span class=s2>&quot;iat&quot;</span>:1698793258,<span class=s2>&quot;jti&quot;</span>:<span class=s2>&quot;e96e94c5c3ef4fbbbd7c2468eb64534b&quot;</span>,<span class=s2>&quot;sub&quot;</span>:1,<span class=s2>&quot;user_id&quot;</span>:1,<span class=s2>&quot;username&quot;</span>:<span class=s2>&quot;john&quot;</span>,<span class=w> </span><span class=s2>&quot;id&quot;</span>:null,<span class=s2>&quot;auth_type&quot;</span>:<span class=s2>&quot;bearer&quot;</span><span class=o>}</span>
</code></pre></div> <p>Note in the <code>AuthModule</code> configuration, we configured the JWT to have an expiration of 5 minutes. If you wait 5 minutes after authenticating before attempting a <code>GET</code> <code>/auth/profile</code> request, you'll receive a <code>401</code> Unauthorized response. This is because the <code>EllarJWT</code> package automatically checks the JWT for its expiration time, saving you the trouble of doing so in your application.</p> <h3 id=refresh-token><strong>Refresh Token</strong><a class=headerlink href=#refresh-token title="Permanent link">&para;</a></h3> <p>This was not included in the requirement, but it might be useful to some developers. So, let us address token refresh using EllarJWT. Depending your application, this illustration may vary.</p> <p>To get this done, we need to edit the <code>sign_in</code> in <code>AuthService</code> to return <code>access_token</code> and <code>refresh_token</code>. We also need to add a <code>refresh_token</code> endpoint to our <code>AuthController</code>.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/services.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>import</span> <span class=nn>typing</span> <span class=k>as</span> <span class=nn>t</span>
<span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>timedelta</span>

<span class=kn>from</span> <span class=nn>ellar.core.security.hashers</span> <span class=kn>import</span> <span class=n>check_password</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>injectable</span>
<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>exceptions</span>
<span class=kn>from</span> <span class=nn>ellar_jwt</span> <span class=kn>import</span> <span class=n>JWTService</span>

<span class=kn>from</span> <span class=nn>..user.services</span> <span class=kn>import</span> <span class=n>UsersService</span>


<span class=nd>@injectable</span><span class=p>()</span>
<span class=k>class</span> <span class=nc>AuthService</span><span class=p>:</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>users_service</span><span class=p>:</span> <span class=n>UsersService</span><span class=p>,</span> <span class=n>jwt_service</span><span class=p>:</span> <span class=n>JWTService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>users_service</span> <span class=o>=</span> <span class=n>users_service</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span> <span class=o>=</span> <span class=n>jwt_service</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>sign_in</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>password</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>:</span>
        <span class=n>user_model</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>users_service</span><span class=o>.</span><span class=n>get_user_by_username</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>user_model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>raise</span> <span class=n>exceptions</span><span class=o>.</span><span class=n>AuthenticationFailed</span><span class=p>()</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>check_password</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>user_model</span><span class=o>.</span><span class=n>password</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>exceptions</span><span class=o>.</span><span class=n>AuthenticationFailed</span><span class=p>()</span>

        <span class=n>result</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;access_token&quot;</span><span class=p>:</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span><span class=o>.</span><span class=n>sign_async</span><span class=p>(</span>
                <span class=n>payload</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>user_model</span><span class=o>.</span><span class=n>serialize</span><span class=p>(),</span> <span class=n>sub</span><span class=o>=</span><span class=n>user_model</span><span class=o>.</span><span class=n>user_id</span><span class=p>)</span>
            <span class=p>),</span>
            <span class=s2>&quot;refresh_token&quot;</span><span class=p>:</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span><span class=o>.</span><span class=n>sign_async</span><span class=p>(</span>
                <span class=n>payload</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>sub</span><span class=o>=</span><span class=n>user_model</span><span class=o>.</span><span class=n>username</span><span class=p>),</span>
                <span class=n>lifetime</span><span class=o>=</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>30</span><span class=p>)</span>
            <span class=p>),</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>result</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>refresh_token</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>refresh_token</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Dict</span><span class=p>:</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>payload</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span><span class=o>.</span><span class=n>decode_async</span><span class=p>(</span><span class=n>refresh_token</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
            <span class=k>raise</span> <span class=n>exceptions</span><span class=o>.</span><span class=n>AuthenticationFailed</span><span class=p>()</span>

        <span class=n>user_model</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>users_service</span><span class=o>.</span><span class=n>get_user_by_username</span><span class=p>(</span><span class=n>payload</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>])</span>
        <span class=k>if</span> <span class=n>user_model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>raise</span> <span class=n>exceptions</span><span class=o>.</span><span class=n>AuthenticationFailed</span><span class=p>()</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s2>&quot;access_token&quot;</span><span class=p>:</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span><span class=o>.</span><span class=n>sign_async</span><span class=p>(</span>
                <span class=n>payload</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>user_model</span><span class=o>.</span><span class=n>serialize</span><span class=p>(),</span> <span class=n>sub</span><span class=o>=</span><span class=n>user_model</span><span class=o>.</span><span class=n>user_id</span><span class=p>)</span>
            <span class=p>),</span>
        <span class=p>}</span>
</code></pre></div></td></tr></table></div> <p>We have modified the sign_in method and added the refresh_token method to handle refresh token actions. The <code>sign_in</code> method return <code>access_token</code> and <code>refresh_token</code> that expires in 30days.</p> <p><div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/controllers.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>Controller</span><span class=p>,</span> <span class=n>ControllerBase</span><span class=p>,</span> <span class=n>post</span><span class=p>,</span> <span class=n>Body</span><span class=p>,</span> <span class=n>get</span><span class=p>,</span> <span class=n>UseGuards</span>
<span class=kn>from</span> <span class=nn>ellar.openapi</span> <span class=kn>import</span> <span class=n>ApiTags</span>
<span class=kn>from</span> <span class=nn>.services</span> <span class=kn>import</span> <span class=n>AuthService</span>
<span class=kn>from</span> <span class=nn>.guards</span> <span class=kn>import</span> <span class=n>AuthGuard</span>


<span class=nd>@Controller</span>
<span class=nd>@ApiTags</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;Authentication&#39;</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s1>&#39;User Authentication Endpoints&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>AuthController</span><span class=p>(</span><span class=n>ControllerBase</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>auth_service</span><span class=p>:</span> <span class=n>AuthService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span> <span class=o>=</span> <span class=n>auth_service</span>

    <span class=nd>@post</span><span class=p>(</span><span class=s2>&quot;/login&quot;</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>sign_in</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>password</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span><span class=o>.</span><span class=n>sign_in</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>password</span><span class=p>)</span>

    <span class=nd>@get</span><span class=p>(</span><span class=s2>&quot;/profile&quot;</span><span class=p>)</span>
    <span class=nd>@UseGuards</span><span class=p>(</span><span class=n>AuthGuard</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_profile</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>user</span>

    <span class=nd>@post</span><span class=p>(</span><span class=s2>&quot;/refresh&quot;</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>refresh_token</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>payload</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Body</span><span class=p>(</span><span class=n>embed</span><span class=o>=</span><span class=kc>True</span><span class=p>)):</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span><span class=o>.</span><span class=n>refresh_token</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> With the above illustration refresh token mechanism is complete. </p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>There are ways of refreshing tokens. This was to illustrate how you can achieve it using ellar-jwt package.</p> </div> <p>You can also vist <a href=http://localhost:8000/docs>http://localhost:8000/docs</a> <img alt="Swagger UI" src=../../img/auth_image.png></p> <h2 id=apply-authguard-globally><strong>Apply AuthGuard Globally</strong><a class=headerlink href=#apply-authguard-globally title="Permanent link">&para;</a></h2> <p>In situations when you need to protect all your endpoints, you can register <code>AuthGuard</code> as a global guard instead of using the <code>@UseGuards</code> decorator in all your controllers or route functions. However, you also need to implement a mechanism to skip the auth guard for certain route functions that don't require it, such as the <code>sign_in</code> route function.</p> <p>First, let us register <code>AuthGuard</code> a global guard in <code>AuthModule</code>.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/module.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>timedelta</span>

<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>GlobalGuard</span><span class=p>,</span> <span class=n>Module</span>
<span class=kn>from</span> <span class=nn>ellar.core</span> <span class=kn>import</span> <span class=n>ModuleBase</span><span class=p>,</span> <span class=n>LazyModuleImport</span> <span class=k>as</span> <span class=n>lazyLoad</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>ProviderConfig</span>
<span class=kn>from</span> <span class=nn>ellar_jwt</span> <span class=kn>import</span> <span class=n>JWTModule</span>

<span class=kn>from</span> <span class=nn>.controllers</span> <span class=kn>import</span> <span class=n>AuthController</span>
<span class=kn>from</span> <span class=nn>.services</span> <span class=kn>import</span> <span class=n>AuthService</span>
<span class=kn>from</span> <span class=nn>.guards</span> <span class=kn>import</span> <span class=n>AuthGuard</span>

<span class=nd>@Module</span><span class=p>(</span>
    <span class=n>modules</span><span class=o>=</span><span class=p>[</span>
        <span class=n>lazyLoad</span><span class=p>(</span><span class=s1>&#39;project_name.users.module:UserModule&#39;</span><span class=p>),</span>
        <span class=n>JWTModule</span><span class=o>.</span><span class=n>setup</span><span class=p>(</span>
            <span class=n>signing_secret_key</span><span class=o>=</span><span class=s2>&quot;my_poor_secret_key_lol&quot;</span><span class=p>,</span> <span class=n>lifetime</span><span class=o>=</span><span class=n>timedelta</span><span class=p>(</span><span class=n>minutes</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
        <span class=p>),</span>
    <span class=p>],</span>
    <span class=n>controllers</span><span class=o>=</span><span class=p>[</span><span class=n>AuthController</span><span class=p>],</span>
    <span class=n>providers</span><span class=o>=</span><span class=p>[</span><span class=n>AuthService</span><span class=p>,</span> <span class=n>ProviderConfig</span><span class=p>(</span><span class=n>GlobalGuard</span><span class=p>,</span> <span class=n>use_class</span><span class=o>=</span><span class=n>AuthGuard</span><span class=p>)],</span>
<span class=p>)</span>
<span class=k>class</span> <span class=nc>AuthModule</span><span class=p>(</span><span class=n>ModuleBase</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Auth Module</span>
<span class=sd>    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div> <p>With this, <code>AuthGuard</code> will be available to all endpoints.</p> <h3 id=anonymous-route-function-mechanism><strong>Anonymous Route Function Mechanism</strong><a class=headerlink href=#anonymous-route-function-mechanism title="Permanent link">&para;</a></h3> <p>Let us define a mechanism for declaring routes as anonymous or public. </p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>Using Route Function MetaData</label><label for=__tabbed_1_2>Using GuardCanActivate</label></div> <div class=tabbed-content> <div class=tabbed-block> <p>One way to achieve this, is by using the <code>set_metadata</code> decorator. We can set some metadata on those functions, and it can be read in AuthGuard. If the metadata is present, we exit the authentication verification and allow the execution to continue.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/guards.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>import</span> <span class=nn>typing</span> <span class=k>as</span> <span class=nn>t</span>

<span class=kn>from</span> <span class=nn>ellar.auth</span> <span class=kn>import</span> <span class=n>UserIdentity</span>
<span class=kn>from</span> <span class=nn>ellar.common.serializer.guard</span> <span class=kn>import</span> <span class=p>(</span>
    <span class=n>HTTPAuthorizationCredentials</span><span class=p>,</span>
<span class=p>)</span>
<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>IExecutionContext</span><span class=p>,</span> <span class=n>set_metadata</span><span class=p>,</span> <span class=n>logger</span>
<span class=kn>from</span> <span class=nn>ellar.auth.guards</span> <span class=kn>import</span> <span class=n>GuardHttpBearerAuth</span>
<span class=kn>from</span> <span class=nn>ellar.core</span> <span class=kn>import</span> <span class=n>Reflector</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>injectable</span>
<span class=kn>from</span> <span class=nn>ellar_jwt</span> <span class=kn>import</span> <span class=n>JWTService</span>

<span class=n>IS_ANONYMOUS</span> <span class=o>=</span> <span class=s1>&#39;is_anonymous&#39;</span>


<span class=k>def</span> <span class=nf>allow_any</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Callable</span><span class=p>:</span>
    <span class=k>return</span> <span class=n>set_metadata</span><span class=p>(</span><span class=n>IS_ANONYMOUS</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>    


<span class=nd>@injectable</span>
<span class=k>class</span> <span class=nc>AuthGuard</span><span class=p>(</span><span class=n>GuardHttpBearerAuth</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>jwt_service</span><span class=p>:</span> <span class=n>JWTService</span><span class=p>,</span> <span class=n>reflector</span><span class=p>:</span> <span class=n>Reflector</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span> <span class=o>=</span> <span class=n>jwt_service</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>reflector</span> <span class=o>=</span> <span class=n>reflector</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>authentication_handler</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>context</span><span class=p>:</span> <span class=n>IExecutionContext</span><span class=p>,</span>
        <span class=n>credentials</span><span class=p>:</span> <span class=n>HTTPAuthorizationCredentials</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>]:</span>
        <span class=n>is_anonymous</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>reflector</span><span class=o>.</span><span class=n>get_all_and_override</span><span class=p>(</span><span class=n>IS_ANONYMOUS</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>get_handler</span><span class=p>(),</span> <span class=n>context</span><span class=o>.</span><span class=n>get_class</span><span class=p>())</span>

        <span class=k>if</span> <span class=n>is_anonymous</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>True</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span><span class=o>.</span><span class=n>decode_async</span><span class=p>(</span><span class=n>credentials</span><span class=o>.</span><span class=n>credentials</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>UserIdentity</span><span class=p>(</span><span class=n>auth_type</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>scheme</span><span class=p>,</span> <span class=o>**</span><span class=n>data</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>ex</span><span class=p>:</span>
            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;[AuthGuard] Exception: </span><span class=si>{</span><span class=n>ex</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>raise_exception</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> <p>We have defined the <code>allow_any</code> metadata decorator in the above illustration and have used Ellar's built-in class <code>Reflector</code> to read the metadata defined at the controller or route function.</p> </div> <div class=tabbed-block> <p>We can create an <code>allow_any</code> decorator function that defines a guard metadata on the decorated function to override the global guard</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/guards.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>import</span> <span class=nn>typing</span> <span class=k>as</span> <span class=nn>t</span>

<span class=kn>from</span> <span class=nn>ellar.auth</span> <span class=kn>import</span> <span class=n>UserIdentity</span>
<span class=kn>from</span> <span class=nn>ellar.common.serializer.guard</span> <span class=kn>import</span> <span class=p>(</span>
    <span class=n>HTTPAuthorizationCredentials</span><span class=p>,</span>
<span class=p>)</span>
<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>IExecutionContext</span><span class=p>,</span> <span class=n>set_metadata</span><span class=p>,</span> <span class=n>constants</span><span class=p>,</span> <span class=n>GuardCanActivate</span><span class=p>,</span> <span class=n>logger</span>
<span class=kn>from</span> <span class=nn>ellar.auth.guards</span> <span class=kn>import</span> <span class=n>GuardHttpBearerAuth</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>injectable</span>
<span class=kn>from</span> <span class=nn>ellar_jwt</span> <span class=kn>import</span> <span class=n>JWTService</span>


<span class=k>def</span> <span class=nf>allow_any</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Callable</span><span class=p>:</span>
    <span class=k>return</span> <span class=n>set_metadata</span><span class=p>(</span><span class=n>constants</span><span class=o>.</span><span class=n>GUARDS_KEY</span><span class=p>,</span> <span class=p>[</span><span class=n>AllowAny</span><span class=p>])</span>


<span class=k>class</span> <span class=nc>AllowAny</span><span class=p>(</span><span class=n>GuardCanActivate</span><span class=p>):</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>can_activate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>IExecutionContext</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
        <span class=k>return</span> <span class=kc>True</span>


<span class=nd>@injectable</span>
<span class=k>class</span> <span class=nc>AuthGuard</span><span class=p>(</span><span class=n>GuardHttpBearerAuth</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>jwt_service</span><span class=p>:</span> <span class=n>JWTService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span> <span class=o>=</span> <span class=n>jwt_service</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>authentication_handler</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>context</span><span class=p>:</span> <span class=n>IExecutionContext</span><span class=p>,</span>
        <span class=n>credentials</span><span class=p>:</span> <span class=n>HTTPAuthorizationCredentials</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>]:</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span><span class=o>.</span><span class=n>decode_async</span><span class=p>(</span><span class=n>credentials</span><span class=o>.</span><span class=n>credentials</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>UserIdentity</span><span class=p>(</span><span class=n>auth_type</span><span class=o>=</span><span class=s2>&quot;bearer&quot;</span><span class=p>,</span> <span class=o>**</span><span class=n>data</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>ex</span><span class=p>:</span>
            <span class=n>logger</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;[AuthGuard] Exception: </span><span class=si>{</span><span class=n>ex</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>raise_exception</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> </div> </div> </div> <h4 id=using-allow_any-decorator-function>Using allow_any decorator function<a class=headerlink href=#using-allow_any-decorator-function title="Permanent link">&para;</a></h4> <p>We have seen from above how to get <code>allow_any</code> decorator function. Now we use it on the <code>refresh</code> and <code>sign in</code> endpoints as shown below:</p> <p><div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/controllers.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>Controller</span><span class=p>,</span> <span class=n>ControllerBase</span><span class=p>,</span> <span class=n>post</span><span class=p>,</span> <span class=n>Body</span><span class=p>,</span> <span class=n>get</span>
<span class=kn>from</span> <span class=nn>ellar.openapi</span> <span class=kn>import</span> <span class=n>ApiTags</span>
<span class=kn>from</span> <span class=nn>.services</span> <span class=kn>import</span> <span class=n>AuthService</span>
<span class=kn>from</span> <span class=nn>.guards</span> <span class=kn>import</span> <span class=n>AuthGuard</span><span class=p>,</span> <span class=n>allow_any</span>


<span class=nd>@Controller</span>
<span class=nd>@ApiTags</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;Authentication&#39;</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s1>&#39;User Authentication Endpoints&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>AuthController</span><span class=p>(</span><span class=n>ControllerBase</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>auth_service</span><span class=p>:</span> <span class=n>AuthService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span> <span class=o>=</span> <span class=n>auth_service</span>

    <span class=nd>@post</span><span class=p>(</span><span class=s2>&quot;/login&quot;</span><span class=p>)</span>
    <span class=nd>@allow_any</span><span class=p>()</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>sign_in</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>password</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span><span class=o>.</span><span class=n>sign_in</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>password</span><span class=p>)</span>

    <span class=nd>@get</span><span class=p>(</span><span class=s2>&quot;/profile&quot;</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_profile</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>user</span>

    <span class=nd>@allow_any</span><span class=p>()</span>
    <span class=nd>@post</span><span class=p>(</span><span class=s2>&quot;/refresh&quot;</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>refresh_token</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>payload</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Body</span><span class=p>(</span><span class=n>embed</span><span class=o>=</span><span class=kc>True</span><span class=p>)):</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span><span class=o>.</span><span class=n>refresh_token</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> Source Code to this example is <a href=https://github.com/python-ellar/ellar/tree/main/examples/03-auth-with-guards>here</a></p> <h2 id=2-authentication-schemes><strong>2. Authentication Schemes</strong><a class=headerlink href=#2-authentication-schemes title="Permanent link">&para;</a></h2> <p>Authentication scheme is another strategy for identifying the user who is using the application. The difference between it and and Guard strategy is your identification executed at middleware layer when processing incoming request while guard execution happens just before route function is executed.</p> <p>Ellar provides <code>BaseAuthenticationHandler</code> contract which defines what is required to set up any authentication strategy. We are going to make some modifications on the existing project to see how we can achieve the same result and to show how authentication handlers in ellar.</p> <h3 id=creating-a-jwt-authentication-handler>Creating a JWT Authentication Handler<a class=headerlink href=#creating-a-jwt-authentication-handler title="Permanent link">&para;</a></h3> <p>Just like AuthGuard, we need to create its equivalent. But first we need to create a <code>auth_scheme.py</code> at the root level of your application for us to define a <code>JWTAuthentication</code> handler. </p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>prject_name/auth_scheme.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>import</span> <span class=nn>typing</span> <span class=k>as</span> <span class=nn>t</span>
<span class=kn>from</span> <span class=nn>ellar.common.serializer.guard</span> <span class=kn>import</span> <span class=p>(</span>
    <span class=n>HTTPAuthorizationCredentials</span><span class=p>,</span>
<span class=p>)</span>
<span class=kn>from</span> <span class=nn>ellar.auth</span> <span class=kn>import</span> <span class=n>UserIdentity</span>
<span class=kn>from</span> <span class=nn>ellar.auth.handlers</span> <span class=kn>import</span> <span class=n>HttpBearerAuthenticationHandler</span>
<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>IHostContext</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>injectable</span>
<span class=kn>from</span> <span class=nn>ellar_jwt</span> <span class=kn>import</span> <span class=n>JWTService</span>


<span class=nd>@injectable</span>
<span class=k>class</span> <span class=nc>JWTAuthentication</span><span class=p>(</span><span class=n>HttpBearerAuthenticationHandler</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>jwt_service</span><span class=p>:</span> <span class=n>JWTService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span> <span class=o>=</span> <span class=n>jwt_service</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>authentication_handler</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>context</span><span class=p>:</span> <span class=n>IHostContext</span><span class=p>,</span>
        <span class=n>credentials</span><span class=p>:</span> <span class=n>HTTPAuthorizationCredentials</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>]:</span>
        <span class=c1># this function will be called by Identity Middleware but only when a `Bearer token` is found on the header request</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>jwt_service</span><span class=o>.</span><span class=n>decode_async</span><span class=p>(</span><span class=n>credentials</span><span class=o>.</span><span class=n>credentials</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>UserIdentity</span><span class=p>(</span><span class=n>auth_type</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>scheme</span><span class=p>,</span> <span class=o>**</span><span class=n>data</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>ex</span><span class=p>:</span>
            <span class=c1># if we cant identity the user or token has expired, we return None.</span>
            <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> <p>Let us make <code>JWTAuthentication</code> Handler available for ellar to use as shown below</p> <p><div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>project_name.server.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>import</span> <span class=nn>os</span>
<span class=kn>from</span> <span class=nn>ellar.common.constants</span> <span class=kn>import</span> <span class=n>ELLAR_CONFIG_MODULE</span>
<span class=kn>from</span> <span class=nn>ellar.app</span> <span class=kn>import</span> <span class=n>AppFactory</span>
<span class=kn>from</span> <span class=nn>ellar.core</span> <span class=kn>import</span> <span class=n>LazyModuleImport</span> <span class=k>as</span> <span class=n>lazyLoad</span>
<span class=kn>from</span> <span class=nn>.auth_scheme</span> <span class=kn>import</span> <span class=n>JWTAuthentication</span>

<span class=n>application</span> <span class=o>=</span> <span class=n>AppFactory</span><span class=o>.</span><span class=n>create_from_app_module</span><span class=p>(</span>
    <span class=n>lazyLoad</span><span class=p>(</span><span class=s1>&#39;project_name.root_module:ApplicationModule&#39;</span><span class=p>),</span>
    <span class=n>config_module</span><span class=o>=</span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
        <span class=n>ELLAR_CONFIG_MODULE</span><span class=p>,</span> <span class=s2>&quot;project_name.config:DevelopmentConfig&quot;</span>
    <span class=p>),</span>
<span class=p>)</span>
<span class=n>application</span><span class=o>.</span><span class=n>add_authentication_schemes</span><span class=p>(</span><span class=n>JWTAuthentication</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> Unlike guards, Authentication handlers are registered global by default as shown in the above illustration. Also, we need to remove <code>GlobalGuard</code> registration we did in <code>AuthModule</code>, so that we don't have too user identification checks.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>In the above illustration, we added JWTAuthentication as a type. This means DI will create JWTAuthentication instance. We can use this method because we want <code>JWTService</code> to be injected when instantiating <code>JWTAuthentication</code>. But if you don't have any need for DI injection, you can use the below. <div class=highlight><pre><span></span><code><span class=o>...</span>
<span class=n>application</span><span class=o>.</span><span class=n>add_authentication_schemes</span><span class=p>(</span><span class=n>JWTAuthentication</span><span class=p>())</span>
</code></pre></div></p> </div> <p>We need to refactor auth controller and mark <code>refresh_token</code> and <code>sign_in</code> function as public routes by using <code>SkipAuth</code> decorator from <code>ellar.auth</code> package.</p> <p><div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/controller.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>Controller</span><span class=p>,</span> <span class=n>ControllerBase</span><span class=p>,</span> <span class=n>post</span><span class=p>,</span> <span class=n>Body</span><span class=p>,</span> <span class=n>get</span>
<span class=kn>from</span> <span class=nn>ellar.auth</span> <span class=kn>import</span> <span class=n>SkipAuth</span><span class=p>,</span> <span class=n>AuthenticationRequired</span>
<span class=kn>from</span> <span class=nn>ellar.openapi</span> <span class=kn>import</span> <span class=n>ApiTags</span>
<span class=kn>from</span> <span class=nn>.services</span> <span class=kn>import</span> <span class=n>AuthService</span>


<span class=nd>@AuthenticationRequired</span><span class=p>(</span><span class=s1>&#39;JWTAuthentication&#39;</span><span class=p>)</span>
<span class=nd>@Controller</span>
<span class=nd>@ApiTags</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;Authentication&#39;</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s1>&#39;User Authentication Endpoints&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>AuthController</span><span class=p>(</span><span class=n>ControllerBase</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>auth_service</span><span class=p>:</span> <span class=n>AuthService</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span> <span class=o>=</span> <span class=n>auth_service</span>

    <span class=nd>@post</span><span class=p>(</span><span class=s2>&quot;/login&quot;</span><span class=p>)</span>
    <span class=nd>@SkipAuth</span><span class=p>()</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>sign_in</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>password</span><span class=p>:</span> <span class=n>Body</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span><span class=o>.</span><span class=n>sign_in</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>password</span><span class=p>)</span>

    <span class=nd>@get</span><span class=p>(</span><span class=s2>&quot;/profile&quot;</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_profile</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>user</span>

    <span class=nd>@SkipAuth</span><span class=p>()</span>
    <span class=nd>@post</span><span class=p>(</span><span class=s2>&quot;/refresh&quot;</span><span class=p>)</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>refresh_token</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>payload</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Body</span><span class=p>(</span><span class=n>embed</span><span class=o>=</span><span class=kc>True</span><span class=p>)):</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>auth_service</span><span class=o>.</span><span class=n>refresh_token</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> In the above illustration, we decorated AuthController with <code>@AuthenticationRequired('JWTAuthentication')</code> to ensure we have authenticated user before executing any route function and, we passed in <code>JWTAuthentication</code> as a parameter, which will be used in openapi doc to define the controller routes security scheme.</p> <p>It is importance to note that when using <code>AuthenticationHandler</code> approach, that you have to always use <code>AuthenticationRequired</code> decorator on route functions or controller that needs protected from anonymous users.</p> <p>But if you have a single form of authentication, you can register <code>AuthenticatedRequiredGuard</code> from <code>eellar.auth.guard</code> module globally just like we did in <a href=#apply-authguard-globally>applying guard globally</a></p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>auth/module.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>timedelta</span>
<span class=kn>from</span> <span class=nn>ellar.auth.guard</span> <span class=kn>import</span> <span class=n>AuthenticatedRequiredGuard</span>
<span class=kn>from</span> <span class=nn>ellar.common</span> <span class=kn>import</span> <span class=n>GlobalGuard</span><span class=p>,</span> <span class=n>Module</span>
<span class=kn>from</span> <span class=nn>ellar.core</span> <span class=kn>import</span> <span class=n>ModuleBase</span><span class=p>,</span> <span class=n>LazyModuleImport</span> <span class=k>as</span> <span class=n>lazyLoad</span>
<span class=kn>from</span> <span class=nn>ellar.di</span> <span class=kn>import</span> <span class=n>ProviderConfig</span>
<span class=kn>from</span> <span class=nn>ellar_jwt</span> <span class=kn>import</span> <span class=n>JWTModule</span>

<span class=kn>from</span> <span class=nn>.controllers</span> <span class=kn>import</span> <span class=n>AuthController</span>
<span class=kn>from</span> <span class=nn>.services</span> <span class=kn>import</span> <span class=n>AuthService</span>


<span class=nd>@Module</span><span class=p>(</span>
    <span class=n>modules</span><span class=o>=</span><span class=p>[</span>
        <span class=n>lazyLoad</span><span class=p>(</span><span class=s1>&#39;project_name.users.module:UserModule&#39;</span><span class=p>),</span>
        <span class=n>JWTModule</span><span class=o>.</span><span class=n>setup</span><span class=p>(</span>
            <span class=n>signing_secret_key</span><span class=o>=</span><span class=s2>&quot;my_poor_secret_key_lol&quot;</span><span class=p>,</span> <span class=n>lifetime</span><span class=o>=</span><span class=n>timedelta</span><span class=p>(</span><span class=n>minutes</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
        <span class=p>),</span>
    <span class=p>],</span>
    <span class=n>controllers</span><span class=o>=</span><span class=p>[</span><span class=n>AuthController</span><span class=p>],</span>
    <span class=n>providers</span><span class=o>=</span><span class=p>[</span><span class=n>AuthService</span><span class=p>,</span> <span class=n>ProviderConfig</span><span class=p>(</span><span class=n>GlobalGuard</span><span class=p>,</span> <span class=n>use_value</span><span class=o>=</span><span class=n>AuthenticatedRequiredGuard</span><span class=p>(</span><span class=s1>&#39;JWTAuthentication&#39;</span><span class=p>,</span> <span class=p>[]))],</span>
<span class=p>)</span>
<span class=k>class</span> <span class=nc>AuthModule</span><span class=p>(</span><span class=n>ModuleBase</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Auth Module</span>
<span class=sd>    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div> <p>Still having the server running, we can test as before</p> <p><div class=highlight><pre><span></span><code>$<span class=w> </span><span class=c1># GET /auth/profile</span>
$<span class=w> </span>curl<span class=w> </span>http://localhost:8000/auth/profile
<span class=o>{</span><span class=s2>&quot;detail&quot;</span>:<span class=s2>&quot;Forbidden&quot;</span><span class=o>}</span><span class=w> </span><span class=c1># status_code=403</span>

$<span class=w> </span><span class=c1># POST /auth/login</span>
$<span class=w> </span>curl<span class=w> </span>-X<span class=w> </span>POST<span class=w> </span>http://localhost:8000/auth/login<span class=w> </span>-d<span class=w> </span><span class=s1>&#39;{&quot;username&quot;: &quot;john&quot;, &quot;password&quot;: &quot;password&quot;}&#39;</span><span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Content-Type: application/json&quot;</span>
<span class=o>{</span><span class=s2>&quot;access_token&quot;</span>:<span class=s2>&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTg3OTE0OTE...&quot;</span><span class=o>}</span>

$<span class=w> </span><span class=c1># GET /profile using access_token returned from previous step as bearer code</span>
$<span class=w> </span>curl<span class=w> </span>http://localhost:8000/auth/profile<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm...&quot;</span>
<span class=o>{</span><span class=s2>&quot;exp&quot;</span>:1698793558,<span class=s2>&quot;iat&quot;</span>:1698793258,<span class=s2>&quot;jti&quot;</span>:<span class=s2>&quot;e96e94c5c3ef4fbbbd7c2468eb64534b&quot;</span>,<span class=s2>&quot;sub&quot;</span>:1,<span class=s2>&quot;user_id&quot;</span>:1,<span class=s2>&quot;username&quot;</span>:<span class=s2>&quot;john&quot;</span>,<span class=w> </span><span class=s2>&quot;id&quot;</span>:null,<span class=s2>&quot;auth_type&quot;</span>:<span class=s2>&quot;bearer&quot;</span><span class=o>}</span>
</code></pre></div> Source Code to this example is <a href=https://github.com/python-ellar/ellar/tree/main/examples/04-auth-with-handlers>here</a></p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 29, 2024</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../techniques/background-task/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Background Tasks"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Background Tasks </div> </div> </a> <a href=../authorization/ class="md-footer__link md-footer__link--next" aria-label="Next: Authorization"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Authorization </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2024 <a href=https://github.com/eadwinCode target=_blank rel=noopener>Eadwin Ezeudoh</a> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tooltips", "search.highlight", "search.share", "search.suggest", "toc.follow", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.prune", "navigation.tabs", "navigation.left", "navigation.tracking"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.c8d2eff1.min.js></script> </body> </html>